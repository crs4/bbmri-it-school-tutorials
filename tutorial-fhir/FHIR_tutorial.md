# FHIR: understanding FHIR and Resources structure 
[TBD]
# Managing APIs in FHIR
[TBD]

# Implementing a IHE PDQ Consumer in FHIR

# Creating a FHIR IG with FHIR Shorthand and Sushi 
In this part of the tutorial, we will learn how to create a FHIR Implementation Guide (IG) using 
FHIR Shorthand (FSH) and the SUSHI tool, starting from a pre-built and configured docker 
image.

## Check the project and run the container for the first time
The project is under ./fhir-fsh-sushi-ig that is a project respecting the structure required 
by fhir shorthnd and sushi for creating a FHIR IG. This includes: 
    - a input/fsh folder with the FSH files: here we will put the .fsh files that define the 
      resources, profiles, value sets, etc. of our IG. All the objects that we are going to 
      profile in the IG will be defined in this folder. Notice that there is only a simple 
      "SpecimenProfile.fsh" file in this folder, that simply defines a profile from the 
      4.0.1 FHIR Specimen resource, but without profiling anything (we will add some rules later).
    - a sushi-config.yaml file that defines some metadata of the generated IG, such as the 
      name, title, description, etc. of the IG. This file is used by SUSHI to generate the IG and we 
      do not have the need to change it for the moment.
    - a ig.ini file, defining some configuration, in particular where the publisher should take the 
      putput files generated by SUSHI. This file is used by the publisher to generate the IG and we
      do not have the need to change it for the moment.

Now, check the docker compose: it runs a container with the SUSHI tool and the publscher script, and 
has all the directories mounted in the container. The container is configured to run the SUSHI tool
and the publisher script when it starts, so we can run the container and generate the IG by running:
```bash
    docker compose up
```
If all it is fine, shou should see a long output in the terminal, that ends with this sentence: 
```
    fhir-fsh-sushi-ig-fhir-ig-1 exited with code 0
```
This means that the SUSHI tool has generated the IG and the publisher script has run successfully.
All the output files are in your local folder, thanks to the mount, and we can open the home page of the IG in a browser by opening the file:
```
    ./fhir-fsh-sushi-ig/input/fsh/output/toc.html
```
Notice that if from here you click on "My custom specimen profile" link, you will se a page where 
the profile Specimen Resource has not differentials (the differetials tab is empty) because we have not 
defined any specific profile rule yet. 

## Adding a profile rule to the Specimen profile
Now we can add a rule to the Specimen profile. Open the file:
```
    ./fhir-fsh-sushi-ig/input/fsh/SpecimenProfile.fsh
```
And add the code to create an extension to the specimen profile, for example:
```fsh
Extension: SpecimenCustodian
Id: specimen-custodian
Title: "Specimen Custodian"
Description: "An extension to indicate the custodian responsible for the specimen."
* value[x] only Reference(Practitioner or Organization)
* ^context.type = #element
* ^context.expression = "Specimen"

Profile: MySpecimenProfile
Parent: Specimen
Id: my-specimen-profile
Title: "My Custom Specimen Profile"
Description: "A specimen profile extending the base Specimen resource"

* extension contains SpecimenCustodian named custodian 1..1
```
Notice that, if put in the same file, the extension definition must be put first, before the profile definition.
The last line of the profile definition adds the extension to the profile, with a cardinality of 1..1, meaning that the extension is mandatory.
Now, we can run the SUSHI tool again to generate the IG with the new profile rule. Run again:
```bash
    docker compose up
```
Check now the diff tab in the profile page of the IG, you should see the new extension added to the profile.

Exercise: now, try to add a new extension to the profile, for example an extension to indicate the 
disease that the specimen is related to, and run again the SUSHI tool to generate the IG with the new profile rule


